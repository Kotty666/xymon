diff -r 901f2e7621ca debian/README
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/debian/README	Sat Aug 18 20:46:51 2007 +0200
@@ -0,0 +1,17 @@
+Hobbit for Debian
+=================
+
+This Debian package follows pretty closely the original debianization shipped
+by upstream. The main differences are
+
+- 'hobbit' depends on 'hobbit-client' rather than conflicting with it; it uses
+  the client package for monitoring the local host. (The client package's init
+  script/daemon is disabled when the server is installed.)
+
+- Access to the monitoring website is restricted to localhost by default.
+  Edit /etc/apache2/hobbit to change this.
+
+- Debconf manages /etc/default/hobbit-client directly without the use of a
+  temporary file in /var/run. (There is no HOBBITSERVERS variable.)
+
+ -- Christoph Berg <myon@debian.org>  Thu, 16 Aug 2007 00:07:40 +0200
diff -r 901f2e7621ca debian/changelog
--- a/debian/changelog	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/changelog	Sat Aug 18 20:46:51 2007 +0200
@@ -1,3 +1,12 @@ hobbit (4.2.0-1) unstable; urgency=low
+hobbit (4.2.0.dfsg-1) unstable; urgency=low
+
+  * Preparing for Debian upload.
+  * Repackaged the source:
+    + Removed non-free tigra menu files from hobbitd/wwwfiles/menu/.
+    + Removed upstream's debian/ dir.
+
+ -- Christoph Berg <myon@debian.org>  Sat, 18 Aug 2007 20:45:10 +0200
+
 hobbit (4.2.0-1) unstable; urgency=low
 
   * Hobbit version 4.2: New upstream release.
diff -r 901f2e7621ca debian/control
--- a/debian/control	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/control	Sat Aug 18 20:46:51 2007 +0200
@@ -1,33 +1,44 @@ Source: hobbit
 Source: hobbit
 Section: net
 Priority: optional
-Maintainer: Henrik Stoerner <henrik@hswn.dk>
-Build-Depends: debhelper (>= 4.0.0), librrd0-dev, libssl-dev, libldap2-dev, libpcre3-dev, fping
-Standards-Version: 3.6.1
+Maintainer: Christoph Berg <myon@debian.org>
+Uploaders: Martin Zobel-Helas <zobel@debian.org>
+Build-Depends: debhelper (>= 4.0.0), librrd2-dev, libssl-dev, libldap2-dev, libpcre3-dev
+Standards-Version: 3.7.2
 
 Package: hobbit
 Architecture: any
-Depends: ${shlibs:Depends}, ${misc:Depends}
+Depends: hobbit-client, ${shlibs:Depends}, ${misc:Depends}, adduser
 Description: monitoring system for systems, networks and applications
- Hobbit is a network- and applications-monitoring system designed
- for use in large-scale networks. But it will also work just fine
- on a small network with just a few nodes. It is low-overhead and
- high-performance, with an easy to use web front-end. It handles
- monitoring of network services, and through client packages it
- can also be used to monitor server-specific items. Alerts can
- trigger when monitoring detects a problem, resulting in e-mails
- or calls to your pager or mobile phone.
+ Hobbit is a network- and applications-monitoring system designed for use in
+ large-scale networks. But it will also work just fine on a small network with
+ just a few nodes. It is low-overhead and high-performance, with an easy to use
+ web front-end. It handles monitoring of network services, and through client
+ packages it can also be used to monitor server-specific items. Alerts can
+ trigger when monitoring detects a problem, resulting in e-mails or calls to
+ your pager or mobile phone.
  .
- Hobbit has a great deal of inspiration from the non-free Big Brother 
- package, but does not include any Big Brother code.
+ Hobbit has a great deal of inspiration from the non-free Big Brother package,
+ but does not include any Big Brother code.
+ .
+ http://hobbitmon.sourceforge.net/
 
 Package: hobbit-client
 Architecture: any
-Conflicts: hobbit
+Conflicts: hobbit (<= 4.2.0-1)
 Depends: ${shlibs:Depends}, ${misc:Depends}
 Description: client for the Hobbit network monitor
- Client data collection package for Hobbit. This gathers
- statistics and data from a single system and reports
- it to the Hobbit monitor. You should run this on all
- systems if you have a Hobbit server installed.
+ Hobbit is a network- and applications-monitoring system designed for use in
+ large-scale networks. But it will also work just fine on a small network with
+ just a few nodes. It is low-overhead and high-performance, with an easy to use
+ web front-end. It handles monitoring of network services, and through client
+ packages it can also be used to monitor server-specific items. Alerts can
+ trigger when monitoring detects a problem, resulting in e-mails or calls to
+ your pager or mobile phone.
+ .
+ This is the client data collection package for Hobbit. It gathers statistics
+ and data from a single system and reports it to the Hobbit monitor. You should
+ run this on all systems if you have a Hobbit server installed.
+ .
+ http://hobbitmon.sourceforge.net/
 
diff -r 901f2e7621ca debian/copyright
--- a/debian/copyright	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/copyright	Sat Aug 18 20:46:51 2007 +0200
@@ -1,13 +1,132 @@ This package was debianized by Henrik St
 This package was debianized by Henrik Stoerner <henrik@hswn.dk> on
 Sun,  6 Mar 2005 21:58:45 +0100.
 
+The current debianization is based on Henrik's and was done by Christoph Berg
+<myon@debian.org> on Wed, 15 Aug 2007 21:09:40 +0200.
+
 It was downloaded from http://sourceforge.net/projects/hobbitmon/
-
-Copyright: Henrik Stoerner <henrik@hswn.dk>
 
 Upstream author: Henrik Stoerner <henrik@hswn.dk>
 
-License: GNU GPL
- On Debian GNU/Linux systems, the complete text of the GNU General
- Public License can be found in `/usr/share/common-licenses/GPL'.
+Copyright:
 
+Most files are carry the following copyright header:
+  Copyright (C) 2002-2006 Henrik Storner
+  This program is released under the GNU General Public License (GPL),
+  version 2. See the file "COPYING" for details.
+
+On Debian GNU/Linux systems, the complete text of the GNU General
+Public License can be found in `/usr/share/common-licenses/GPL'.
+
+Other copyrights:
+
+Several files in bbnet/:
+  Copyright 1998 by the Massachusetts Institute of Technology.
+  Copyright 1998, 2000 by the Massachusetts Institute of Technology.
+  Copyright (C) 2004 by Daniel Stenberg et al
+
+  Permission to use, copy, modify, and distribute this
+  software and its documentation for any purpose and without
+  fee is hereby granted, provided that the above copyright
+  notice appear in all copies and that both that copyright
+  notice and this permission notice appear in supporting
+  documentation, and that the name of M.I.T. not be used in
+  advertising or publicity pertaining to distribution of the
+  software without specific, written prior permission.
+  M.I.T. makes no representations about the suitability of
+  this software for any purpose.  It is provided "as is"
+  without express or implied warranty.
+
+client/hobbitclient-sco_sv.sh:
+  SCO_SV client for Hobbit
+  Copyright (C) 2005-2006 Henrik Storner
+  Copyright (C) 2006 Charles Goyard
+
+client/runclient.sh:
+  Copyright (C) 2005-2006 Henrik Storner
+  "status" section (C) Scott Smith 2006
+
+hobbitd/webfiles/zoom.js:
+  Copyright (C) 2004  Eric Steffen
+  This program is free software; you can redistribute it and/or
+  modify it under the terms of the GNU General Public License
+  as published by the Free Software Foundation; either version 2
+  of the License, or (at your option) any later version.
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+lib/md5.c:
+  This file is part of the Hobbit monitor library, but was written by
+  Peter Deutsch and released under the GNU GPL.
+  Copyright (C) 1999, 2000, 2002 Aladdin Enterprises.  All rights reserved.
+  This software is provided 'as-is', without any express or implied
+  warranty.  In no event will the authors be held liable for any damages
+  arising from the use of this software.
+  Permission is granted to anyone to use this software for any purpose,
+  including commercial applications, and to alter it and redistribute it
+  freely, subject to the following restrictions:
+  1. The origin of this software must not be misrepresented; you must not
+     claim that you wrote the original software. If you use this software
+     in a product, an acknowledgment in the product documentation would be
+     appreciated but is not required.
+  2. Altered source versions must be plainly marked as such, and must not be
+     misrepresented as being the original software.
+  3. This notice may not be removed or altered from any source distribution.
+
+lib/ripemd.h:
+  Copyright (C) 1995-1998 Eric Young (eay@cryptsoft.com)
+  All rights reserved.
+
+  This package is an SSL implementation written
+  by Eric Young (eay@cryptsoft.com).
+  The implementation was written so as to conform with Netscapes SSL.
+
+  This library is free for commercial and non-commercial use as long as
+  the following conditions are aheared to.  The following conditions
+  apply to all code found in this distribution, be it the RC4, RSA,
+  lhash, DES, etc., code; not just the SSL code.  The SSL documentation
+  included with this distribution is covered by the same copyright terms
+  except that the holder is Tim Hudson (tjh@cryptsoft.com).
+
+  Copyright remains Eric Young's, and as such any Copyright notices in
+  the code are not to be removed.
+  If this package is used in a product, Eric Young should be given attribution
+  as the author of the parts of the library used.
+  This can be in the form of a textual message at program startup or
+  in documentation (online or textual) provided with the package.
+
+  Redistribution and use in source and binary forms, with or without
+  modification, are permitted provided that the following conditions
+  are met:
+  1. Redistributions of source code must retain the copyright
+     notice, this list of conditions and the following disclaimer.
+  2. Redistributions in binary form must reproduce the above copyright
+     notice, this list of conditions and the following disclaimer in the
+     documentation and/or other materials provided with the distribution.
+  3. All advertising materials mentioning features or use of this software
+     must display the following acknowledgement:
+     "This product includes cryptographic software written by
+      Eric Young (eay@cryptsoft.com)"
+     The word 'cryptographic' can be left out if the rouines from the library
+     being used are not cryptographic related :-).
+  4. If you include any Windows specific code (or a derivative thereof) from 
+     the apps directory (application code) you must include an acknowledgement:
+     "This product includes software written by Tim Hudson (tjh@cryptsoft.com)"
+
+  THIS SOFTWARE IS PROVIDED BY ERIC YOUNG ``AS IS'' AND
+  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+  ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
+  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
+  DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
+  OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+  HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
+  LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
+  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+  SUCH DAMAGE.
+  The licence and distribution terms for any publically available version or
+  derivative of this code cannot be changed.  i.e. this code cannot simply be
+  copied and put under another distribution licence
+  [including the GNU Public Licence.]
diff -r 901f2e7621ca debian/dropdown.css
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/debian/dropdown.css	Sat Aug 18 20:46:51 2007 +0200
@@ -0,0 +1,60 @@
+#menue {
+position:absolute;
+top: 0px;
+left: 0;
+padding-bottom: 2px;
+z-index: 200;
+}
+
+.outer {
+float: left;
+display: block;
+overflow: hidden;
+width: 10em;
+height: 1.3em;
+text-align: left;
+border: 1px solid #123456;
+font: 12px Tahoma, Verdana, Geneva, Arial, Helvetica, sans-serif;
+background: #123456;
+color: #FFFFFF;
+}
+.outer:hover {
+height: auto;
+border: 1px solid #FFFFFF;
+background: #5AA7E5;
+color: #FFFFFF;
+}
+
+a.inner-1 {
+margin-top: 2px;
+}
+a.inner,
+a.inner-1 {
+display: block;
+width: 9.9em;
+padding: 2px 0;
+text-decoration: none;
+font-weight: normal;
+border: 0px;
+color: #000000;
+background: #46B446;
+}
+a:visited.inner,
+a:visited.inner-1 {
+color: #202020;
+background: #46B446;
+}
+a:hover.inner,
+a:hover.inner-1 {
+background-color: #f7eedb;
+background: #5AE55A;
+}
+
+span.menutag {
+display: block;
+cursor: default;
+}
+
+span.invis {
+display: none;
+}
diff -r 901f2e7621ca debian/hobbit-client.config
--- a/debian/hobbit-client.config	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.config	Sat Aug 18 20:46:51 2007 +0200
@@ -10,17 +10,26 @@ if [ -e $CONFIGFILE ]; then
    . $CONFIGFILE || true
 fi
 
-if [ "$HOBBITSERVERS" != "" ]; then
-   db_set hobbit-client/HOBBITSERVERS $HOBBITSERVERS
+if [ "$BBDISP" != "" ]; then
+   db_set hobbit-client/BBDISP $BBDISP
+else
+   db_set hobbit-client/BBDISP 127.0.0.1
+fi
+
+if [ "$BBDISPLAYS" != "" ]; then
+   db_set hobbit-client/BBDISPLAYS $BBDISPLAYS
+else
+   db_set hobbit-client/BBDISPLAYS ""
 fi
 
 if [ "$CLIENTHOSTNAME" != "" ]; then
    db_set hobbit-client/CLIENTHOSTNAME $CLIENTHOSTNAME
 else
-   db_set hobbit-client/CLIENTHOSTNAME `hostname`
+   db_set hobbit-client/CLIENTHOSTNAME `hostname -f`
 fi
 
-db_input medium hobbit-client/HOBBITSERVERS || true
+db_input high hobbit-client/BBDISP || true
+db_input low hobbit-client/BBDISPLAYS || true
 db_input medium hobbit-client/CLIENTHOSTNAME || true
 db_go || true
 
diff -r 901f2e7621ca debian/hobbit-client.default
--- a/debian/hobbit-client.default	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.default	Sat Aug 18 20:46:51 2007 +0200
@@ -10,7 +10,7 @@
 # or (multiple servers)
 #   HOBBITSERVERS="10.0.0.1 192.168.1.1" 
 
-HOBBITSERVERS=""
+HOBBITSERVERS="127.0.0.1"
 
 # Hostname used by the client for its reports.
 # Must match the name for this host in the Hobbit servers'
diff -r 901f2e7621ca debian/hobbit-client.dirs
--- a/debian/hobbit-client.dirs	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.dirs	Sat Aug 18 20:46:51 2007 +0200
@@ -1,1 +1,3 @@
-/etc/default
+etc/default
+usr/bin
+var/run/hobbit
diff -r 901f2e7621ca debian/hobbit-client.files
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/debian/hobbit-client.files	Sat Aug 18 20:46:51 2007 +0200
@@ -0,0 +1,13 @@
+usr/share/man/man1/bb.1
+usr/share/man/man1/bbcmd.1
+usr/share/man/man1/bbdigest.1
+usr/share/man/man1/bbhostgrep.1
+usr/share/man/man1/bbhostshow.1
+usr/share/man/man5/clientlaunch.cfg.5
+usr/share/man/man1/clientupdate.1
+usr/share/man/man7/hobbit.7
+usr/share/man/man5/hobbitclient.cfg.5
+usr/share/man/man8/hobbitlaunch.8
+usr/share/man/man1/logfetch.1
+usr/share/man/man8/msgcache.8
+usr/share/man/man1/orcahobbit.1
diff -r 901f2e7621ca debian/hobbit-client.init
--- a/debian/hobbit-client.init	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.init	Sat Aug 18 20:46:51 2007 +0200
@@ -16,50 +16,36 @@ DMNOPTS=""
 DMNOPTS=""
 if [ -f /etc/default/hobbit-client ] ; then
 	. /etc/default/hobbit-client
-else
-	echo "Installation failure - missing /etc/default/hobbit-client"
-	exit 1
-fi
-
-if [ "$HOBBITSERVERS" = "" ]; then
-	echo "Please configure HOBBITSERVERS in /etc/default/hobbit-client"
-	exit 1
-fi
-
-set $HOBBITSERVERS
-if [ $# -eq 1 ]; then
-	echo "BBDISP=\"$HOBBITSERVERS\"" >/var/run/hobbitclient-runtime.cfg
-	echo "BBDISPLAYS=\"\"" >>/var/run/hobbitclient-runtime.cfg
-else
-	echo "BBDISP=\"0.0.0.0\"" >/var/run/hobbitclient-runtime.cfg
-	echo "BBDISPLAYS=\"$HOBBITSERVERS\"" >>/var/run/hobbitclient-runtime.cfg
-fi
-
-if [ "$CLIENTHOSTNAME" != "" ]; then
-	DMNOPTS="${DMNOPTS} --hostname=${CLIENTHOSTNAME}"
-fi
-if [ "$CLIENTOS" != "" ]; then
-	DMNOPTS="${DMNOPTS} --os=${CLIENTOS}"
 fi
 
 set -e
 
 case "$CMD" in
   start)
+	# do not run the client script on the server
+	[ -x /usr/lib/hobbit/server/bin/hobbitd ] && exit 0
+
+	if [ "$CLIENTHOSTNAME" != "" ]; then
+		DMNOPTS="${DMNOPTS} --hostname=${CLIENTHOSTNAME}"
+	fi
+	if [ "$CLIENTOS" != "" ]; then
+		DMNOPTS="${DMNOPTS} --os=${CLIENTOS}"
+	fi
+
 	echo -n "Starting $DESC: "
-	su -c "$DAEMON $DMNOPTS start" - hobbit
+	start-stop-daemon --exec $DAEMON --chuid hobbit --start -- \
+		$DMNOPTS start
 	echo "$NAME."
 	;;
   stop)
 	echo -n "Stopping $DESC: "
-	su -c "$DAEMON stop" - hobbit
+	su -c "$DAEMON stop" - hobbit || true
 	echo "$NAME."
 	;;
   restart|force-reload)
-	echo -n "Restarting $DESC: "
-	su -c "$DAEMON stop" - hobbit
-	su -c "$DAEMON $DMNOPTS start" - hobbit
-	echo "$NAME."
+	$0 stop
+	sleep 1
+	$0 start
 	;;
   *)
 	N=/etc/init.d/$NAME
diff -r 901f2e7621ca debian/hobbit-client.postinst
--- a/debian/hobbit-client.postinst	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.postinst	Sat Aug 18 20:46:51 2007 +0200
@@ -2,8 +2,6 @@
 # postinst script for hobbit
 #
 # see: dh_installdeb(1)
-
-set -e
 
 # summary of how this script can be called:
 #        * <postinst> `configure' <most-recently-configured-version>
@@ -20,26 +18,45 @@ CONFIGFILE=/etc/default/hobbit-client
 CONFIGFILE=/etc/default/hobbit-client
 . /usr/share/debconf/confmodule
 
+set -e
+
 case "$1" in
     configure)
-        # Setup permissions for the newly created "hobbit" user to write
+	getent group hobbit > /dev/null || addgroup --system hobbit
+	getent passwd hobbit > /dev/null || adduser --system \
+		--home /var/run/hobbit --no-create-home \
+		--ingroup hobbit --disabled-password --disabled-login \
+		--gecos "Hobbit System Monitor" hobbit
+
+	# Setup permissions for the newly created "hobbit" user to write
 	# data where he needs to.
 	# NB: Dont change the "tmp" directory, since it is a symlink to /tmp
+	test -d /var/run/hobbit || mkdir /var/run/hobbit
+	chown hobbit:hobbit /var/run/hobbit
         cd /var/log/hobbit; chown hobbit:hobbit .
 	cd /usr/lib/hobbit/client; chown hobbit:hobbit logs; chmod 755 logs
 
 	# Do the debconf stuff
-	db_get hobbit-client/HOBBITSERVERS
-	HOBBITSERVERS="$RET"
+	db_get hobbit-client/BBDISP
+	BBDISP="$RET"
+	db_get hobbit-client/BBDISPLAYS
+	BBDISPLAYS="$RET"
 	db_get hobbit-client/CLIENTHOSTNAME
 	CLIENTHOSTNAME="$RET"
 	db_stop
 
         # Update configuration file
-	sed -e 's/^HOBBITSERVERS=.*/HOBBITSERVERS=\"${HOBBITSERVERS}\"/'	\
-	    -e 's/^CLIENTHOSTNAME=.*/CLIENTHOSTNAME=\"${CLIENTHOSTNAME}\"/'	\
-	    < $CONFIGFILE > $CONFIGFILE.tmp
-	mv -f $CONFIGFILE.tmp $CONFIGFILE
+	cat > $CONFIGFILE <<EOF
+# File managed by debconf
+# You may edit settings, but do not add new or otherwise modify lines
+# Hobbit server to report to (preferably IP address)
+BBDISP="${BBDISP}"
+# If this client reports to several servers, set BBDISP to 0.0.0.0 and put a
+# space-separated list of servers in BBDISPLAYS (otherwise, leave it empty)
+BBDISPLAYS="${BBDISPLAYS}"
+# This client's hostname, must match the entry in bb-hosts on the server
+CLIENTHOSTNAME="${CLIENTHOSTNAME}"
+EOF
     ;;
 
     abort-upgrade|abort-remove|abort-deconfigure)
diff -r 901f2e7621ca debian/hobbit-client.postrm
--- a/debian/hobbit-client.postrm	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.postrm	Sat Aug 18 20:46:51 2007 +0200
@@ -17,24 +17,27 @@ set -e
 # for details, see http://www.debian.org/doc/debian-policy/ or
 # the debian-policy package
 
+# Before deluser so debconf still works
+#DEBHELPER#
 
 case "$1" in
-       purge|disappear)
-        # userdel hobbit - maybe later
+	purge|disappear)
+	rm -rf /var/lib/hobbit /var/log/hobbit /var/run/hobbit /etc/hobbit
+	if test -x /usr/sbin/deluser ; then
+		deluser hobbit || true
+	fi
+	if test -x /usr/sbin/delgroup ; then
+		delgroup --only-if-empty hobbit || true
+	fi
 	;;
 
-       remove|upgrade|failed-upgrade|abort-install|abort-upgrade)
-        ;;
+	remove|upgrade|failed-upgrade|abort-install|abort-upgrade)
+	;;
 
-    *)
-        echo "postrm called with unknown argument \`$1'" >&2
-        exit 1
-
+	*)
+	echo "postrm called with unknown argument \`$1'" >&2
+	exit 1
+	;;
 esac
 
-# dh_installdeb will replace this with shell code automatically
-# generated by other debhelper scripts.
-
-#DEBHELPER#
-
 exit 0
diff -r 901f2e7621ca debian/hobbit-client.preinst
--- a/debian/hobbit-client.preinst	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.preinst	Sat Aug 18 20:46:51 2007 +0200
@@ -16,12 +16,10 @@ set -e
 
 case "$1" in
     install)
-	/usr/sbin/groupadd hobbit || true
-	/usr/sbin/useradd -g hobbit -c "Hobbit user" -d /usr/lib/hobbit hobbit || true
 	;;
 
     upgrade)
-	/etc/init.d/hobbit stop || true
+	invoke-rc.d hobbit-client stop || true
 	;;
 
     abort-upgrade)
@@ -33,9 +31,6 @@ case "$1" in
     ;;
 esac
 
-# dh_installdeb will replace this with shell code automatically
-# generated by other debhelper scripts.
-
 #DEBHELPER#
 
 exit 0
diff -r 901f2e7621ca debian/hobbit-client.templates
--- a/debian/hobbit-client.templates	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit-client.templates	Sat Aug 18 20:46:51 2007 +0200
@@ -1,19 +1,25 @@ Template: hobbit-client/HOBBITSERVERS
-Template: hobbit-client/HOBBITSERVERS
+Template: hobbit-client/BBDISP
+Type: string
+Default: 127.0.0.1
+Description: Hobbit server (BBDISP)
+ The network address used to access your Hobbit server is stored in the
+ variable BBDISP. Consider using the IP-adress instead of a hostname, in
+ case of a problem DNS might not work.
+
+Template: hobbit-client/BBDISPLAYS
 Type: string
 Default: 
-Description: Hobbit server
- The network address used to access your Hobbit server(s).
- If you have multiple server, list all of them separated by
- spaces.
- Consider using the IP-adresses instead of hostnames, in
- case of a problem DNS might not work.
+Description: Hobbit server list (BBDISPLAYS)
+ The network addresses used to access your Hobbit servers. If you have multiple
+ servers, set BBDISP to 0.0.0.0, and set BBDISPLAYS to a space-separated list
+ of hostnames (or IPs). (Otherwise leave it empty.)
 
 Template: hobbit-client/CLIENTHOSTNAME
 Type: string
 Default: 
 Description: Client hostname
-  The hostname used by the Hobbit client when sending
-  reports to the Hobbit server. This name must match 
-  the named used in the bb-hosts file on the Hobbit
-  server.
+ The hostname used by the Hobbit client when sending
+ reports to the Hobbit server. This name must match 
+ the named used in the bb-hosts file on the Hobbit
+ server.
 
diff -r 901f2e7621ca debian/hobbit.conffiles
--- a/debian/hobbit.conffiles	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.conffiles	Sat Aug 18 20:46:51 2007 +0200
@@ -1,3 +0,0 @@
-/var/lib/hobbit/www/menu/menu_items.js
-/var/lib/hobbit/www/menu/menu_tpl.js
-/var/lib/hobbit/www/menu/menu.css
diff -r 901f2e7621ca debian/hobbit.config
--- a/debian/hobbit.config	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.config	Sat Aug 18 20:46:51 2007 +0200
@@ -1,8 +1,6 @@
 #!/bin/sh
 
-# Must remove the area-specific envs - debconf chokes on them.
-egrep "^[a-zA-Z0-9_]+=" /etc/hobbit/hobbitserver.cfg >/etc/hobbit/hobbitserver.cfg.dbinst
-CONFIGFILE=/etc/hobbit/hobbitserver.cfg.dbinst
+CONFIGFILE=/etc/default/hobbit
 
 set -e
 . /usr/share/debconf/confmodule
@@ -11,28 +9,26 @@ if [ -e $CONFIGFILE ]; then
    . $CONFIGFILE || true
 fi
 
-if [ "$BBSERVERHOSTNAME" != "" -a "$BBSERVERHOSTNAME" != "localhost" ]; then
+if [ "$BBSERVERHOSTNAME" != "" ] && [ "$BBSERVERHOSTNAME" != "localhost" ]; then
    db_set hobbit/BBSERVERHOSTNAME $BBSERVERHOSTNAME
 else
-   db_set hobbit/BBSERVERHOSTNAME `hostname`
+   db_set hobbit/BBSERVERHOSTNAME `hostname -f`
 fi
 
-if [ "$BBSERVERIP" != "" -a "$BBSERVERIP" != "127.0.0.1" ]; then
+if [ "$BBSERVERIP" != "" ] && [ "$BBSERVERIP" != "127.0.0.1" ]; then
    db_set hobbit/BBSERVERIP $BBSERVERIP
 else
    db_set hobbit/BBSERVERIP 127.0.0.1
 fi
 
-if [ "$BBSERVERWWWNAME" != "" -a "$BBSERVERWWWNAME" != "localhost" ]; then
+if [ "$BBSERVERWWWNAME" != "" ] && [ "$BBSERVERWWWNAME" != "localhost" ]; then
    db_set hobbit/BBSERVERWWWNAME $BBSERVERWWWNAME
 else
-   db_set hobbit/BBSERVERWWWNAME `hostname`
+   db_set hobbit/BBSERVERWWWNAME `hostname -f`
 fi
 
-db_input medium hobbit/BBSERVERHOSTNAME || true
-db_input medium hobbit/BBSERVERIP || true
-db_input medium hobbit/BBSERVERWWWNAME || true
+db_input low hobbit/BBSERVERHOSTNAME || true
+db_input low hobbit/BBSERVERIP || true
+db_input low hobbit/BBSERVERWWWNAME || true
 db_go || true
 
-rm -f /etc/hobbit/hobbitserver.cfg.dbinst
-
diff -r 901f2e7621ca debian/hobbit.dirs
--- a/debian/hobbit.dirs	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.dirs	Sat Aug 18 20:46:51 2007 +0200
@@ -1,2 +1,3 @@ usr/bin
-usr/bin
-usr/sbin
+etc/apache2/conf.d
+usr/share/hobbit
+var/run/hobbit
diff -r 901f2e7621ca debian/hobbit.init
--- a/debian/hobbit.init	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.init	Sat Aug 18 20:46:51 2007 +0200
@@ -1,52 +1,95 @@
-#! /bin/sh
+#!/bin/sh
+
+# Startup script for the Hobbit monitor
 #
+# This starts the "hobbitlaunch" tool, which in turn starts
+# all of the other Hobbit server programs.
 
-PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
-DAEMON=/usr/lib/hobbit/server/hobbit.sh
-NAME=hobbit
-DESC=hobbit
+PIDFILE=/var/run/hobbit/hobbitlaunch.pid
+DAEMON=/usr/lib/hobbit/server/bin/hobbitlaunch
 
 test -x $DAEMON || exit 0
 
-# Include hobbit defaults if available
-if [ -f /etc/default/hobbit ] ; then
-	. /etc/default/hobbit
-fi
+case "$1" in
+   "start")
+	if test -s $PIDFILE
+	then
+		kill -0 `cat $PIDFILE`
+		if test $? -eq 0
+		then
+			echo "Hobbit appears to be running, doing restart"
+			$0 stop
+		else
+			rm -f $PIDFILE
+		fi
+	fi
 
-set -e
+	start-stop-daemon --exec $DAEMON --chuid hobbit --start -- \
+		--config=/etc/hobbit/hobbitlaunch.cfg \
+		--env=/etc/hobbit/hobbitserver.cfg \
+		--log=/var/log/hobbit/hobbitlaunch.log --pidfile=$PIDFILE
+	echo "Hobbit started"
+	;;
 
-case "$1" in
-  start)
-	echo -n "Starting $DESC: "
-	su -c "$DAEMON start" - hobbit
-	echo "$NAME."
+   "stop")
+	if test -s $PIDFILE
+	then
+		kill -TERM `cat $PIDFILE`
+		echo "Hobbit stopped"
+	else
+		echo "Hobbit is not running"
+	fi
+	rm -f $PIDFILE
 	;;
-  stop)
-	echo -n "Stopping $DESC: "
-	su -c "$DAEMON stop" - hobbit
-	echo "$NAME."
+
+   "status")
+	if test -s $PIDFILE
+	then
+		kill -0 `cat $PIDFILE`
+		if test $? -eq 0
+		then
+			echo "Hobbit (hobbitlaunch) running with PID `cat $PIDFILE`"
+		else
+			echo "Hobbit not running, removing stale PID file"
+			rm -f $PIDFILE
+		fi
+	else
+		echo "Hobbit (hobbitlaunch) does not appear to be running"
+	fi
 	;;
-  reload|force-reload)
-	echo "Reloading $DESC configuration files."
-	su -c "$DAEMON reload" - hobbit
-	echo "$NAME."
-  	;;
-  restart)
-	echo -n "Restarting $DESC: "
-	su -c "$DAEMON restart" - hobbit
-	echo "$NAME."
+
+   "restart"|"force-reload")
+	if test -s $PIDFILE
+	then
+		$0 stop
+		sleep 5
+		$0 start
+	else
+		echo "hobbitlaunch does not appear to be running, starting it"
+		$0 start
+	fi
 	;;
-  rotate)
-	echo -n "Rotating log for $DESC: "
-  	su -c "$DAEMON rotate" - hobbit
-	echo "$NAME."
+
+   "reload")
+	if test -s $PIDFILE
+	then
+		echo "Reloading hobbitd config."
+		kill -HUP `cat /var/run/hobbit/hobbitd.pid`
+	else
+		echo "hobbitd not running (no PID file)"
+	fi
 	;;
-  *)
-	N=/etc/init.d/$NAME
-	# echo "Usage: $N {start|stop|restart|reload|force-reload}" >&2
-	echo "Usage: $N {start|stop|restart|force-reload}" >&2
-	exit 1
+
+   "rotate")
+   	for PIDFILE in /var/run/hobbit/*.pid
+	do
+		kill -HUP `cat $PIDFILE`
+	done
 	;;
+
+   *)
+   	echo "Usage: $0 start|stop|restart|force-reload|reload|status|rotate"
+	break;
 esac
 
 exit 0
diff -r 901f2e7621ca debian/hobbit.postinst
--- a/debian/hobbit.postinst	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.postinst	Sat Aug 18 20:46:51 2007 +0200
@@ -4,13 +4,6 @@
 # see: dh_installdeb(1)
 
 set -e
-
-# Substitute in the values from the debconf db.
-# Must remove the area-specific envs - debconf chokes on them.
-egrep "^[a-zA-Z0-9_]+=" /etc/hobbit/hobbitserver.cfg >/etc/hobbit/hobbitserver.cfg.dbinst
-CONFIGFILE=/etc/hobbit/hobbitserver.cfg.dbinst
-. /usr/share/debconf/confmodule
-
 
 # summary of how this script can be called:
 #        * <postinst> `configure' <most-recently-configured-version>
@@ -36,6 +29,9 @@ case "$1" in
 	chown root /usr/lib/hobbit/server/bin/hobbitping; chmod 4755 /usr/lib/hobbit/server/bin/hobbitping
 	cd /usr/lib/hobbit/client; chown hobbit:hobbit logs tmp; chmod u+w logs tmp
 
+	CONFIGFILE=/etc/default/hobbit
+	. /usr/share/debconf/confmodule
+
 	# Do the debconf stuff
 	db_get hobbit/BBSERVERHOSTNAME
 	BBSERVERHOSTNAME="$RET"
@@ -46,12 +42,36 @@ case "$1" in
 	db_stop
 
 	# Update configuration file
-	cp -a -f $CONFIGFILE $CONFIGFILE.tmp
-	sed -e 's/^BBSERVERHOSTNAME=.*/BBSERVERHOSTNAME=\"${BBSERVERHOSTNAME}\"/' \
-	    -e 's/^BBSERVERIP=.*/BBSERVERIP=\"${BBSERVERIP}\"/'                   \
-	    -e 's/^BBSERVERWWWNAME=.*/BBSERVERWWWNAME=\"${BBSERVERWWWNAME}\"/'    \
-	    < $CONFIGFILE > $CONFIGFILE.tmp
-	mv -f $CONFIGFILE.tmp $CONFIGFILE
+	cat > $CONFIGFILE <<EOF
+# File managed by debconf
+# You may edit settings, but do not add new or otherwise modify lines
+BBSERVERHOSTNAME="${BBSERVERHOSTNAME}" # The hostname of your server
+BBSERVERIP="${BBSERVERIP}" # The IP-address of your server. Use the real one, not 127.0.0.1 .
+BBSERVERWWWNAME="${BBSERVERWWWNAME}" # The name used for this hosts' webserver
+EOF
+
+	if ! test -e /etc/hobbit/bb-hosts ; then
+		cat > /etc/hobbit/bb-hosts <<EOF
+#
+# Master configuration file for Hobbit
+#
+# This file defines several things:
+#
+# 1) By adding hosts to this file, you define hosts that are monitored by Hobbit
+# 2) By adding "page", "subpage", "group" definitions, you define the layout
+#    of the Hobbit webpages, and how hosts are divided among the various webpages 
+#    that Hobbit generates.
+# 3) Several other definitions can be done for each host, see the bb-hosts(5)
+#    man-page.
+#
+# You need to define at least the Hobbit server itself here.
+
+$BBSERVERIP	$BBSERVERHOSTNAME	# bbd http://localhost/
+EOF
+	fi
+
+	touch /etc/hobbit/hobbitpasswd /etc/hobbit/hobbitgroups
+	test -e /etc/init.d/apache2 && invoke-rc.d apache2 reload
     ;;
 
     abort-upgrade|abort-remove|abort-deconfigure)
@@ -69,6 +89,5 @@ esac
 
 #DEBHELPER#
 
-rm -f /etc/hobbit/hobbitserver.cfg.dbinst
 exit 0
 
diff -r 901f2e7621ca debian/hobbit.postrm
--- a/debian/hobbit.postrm	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.postrm	Sat Aug 18 20:46:51 2007 +0200
@@ -17,24 +17,23 @@ set -e
 # for details, see http://www.debian.org/doc/debian-policy/ or
 # the debian-policy package
 
+#DEBHELPER
 
 case "$1" in
-       purge|disappear)
-        # userdel hobbit - maybe later
+	purge|disappear)
+	rm -f /etc/hobbit/bb-hosts /etc/hobbit/hobbitgroups /etc/hobbit/hobbitpasswd
 	;;
 
-       remove|upgrade|failed-upgrade|abort-install|abort-upgrade)
-        ;;
+	remove)
+	;;
 
-    *)
-        echo "postrm called with unknown argument \`$1'" >&2
-        exit 1
+	upgrade|failed-upgrade|abort-install|abort-upgrade)
+	;;
 
+	*)
+	echo "postrm called with unknown argument \`$1'" >&2
+	exit 1
+	;;
 esac
 
-# dh_installdeb will replace this with shell code automatically
-# generated by other debhelper scripts.
-
-#DEBHELPER#
-
 exit 0
diff -r 901f2e7621ca debian/hobbit.preinst
--- a/debian/hobbit.preinst	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.preinst	Sat Aug 18 20:46:51 2007 +0200
@@ -16,12 +16,10 @@ set -e
 
 case "$1" in
     install)
-	/usr/sbin/groupadd hobbit || true
-	/usr/sbin/useradd -g hobbit -c "Hobbit user" -d /usr/lib/hobbit hobbit || true
 	;;
 
     upgrade)
-	/etc/init.d/hobbit stop || true
+	invoke-rc.d hobbit stop || true
 	;;
 
     abort-upgrade)
@@ -33,9 +31,6 @@ case "$1" in
     ;;
 esac
 
-# dh_installdeb will replace this with shell code automatically
-# generated by other debhelper scripts.
-
 #DEBHELPER#
 
 exit 0
diff -r 901f2e7621ca debian/hobbit.prerm
--- a/debian/hobbit.prerm	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/hobbit.prerm	Sat Aug 18 20:46:51 2007 +0200
@@ -19,7 +19,6 @@ set -e
 
 case "$1" in
     remove|upgrade|deconfigure)
-        /etc/init.d/hobbit stop
         ;;
     failed-upgrade)
         ;;
diff -r 901f2e7621ca debian/menu.cfg
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/debian/menu.cfg	Sat Aug 18 20:46:51 2007 +0200
@@ -0,0 +1,36 @@
+HOBBITMENU=\" <div id=\"menue\"> \
+    <div class=\"outer\"> \
+      <span class=\"menutag\">Views<span class=\"invis\">: </span></span> \
+	<a class=\"inner-1\" href=\"/hobbit/bb.html\">Main view</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/bb2.html\">All non-green view</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-cgi/hobbit-nkview.sh\">Critical systems</a> \
+    </div> \
+    <div class=\"outer\"> \
+      <span class=\"menutag\">Reports<span class=\"invis\">: </span></span> \
+	<a class=\"inner-1\" href=\"/hobbit-cgi/bb-eventlog.sh\">Event log Report</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-cgi/bb-rep.sh\">Availability Report</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-cgi/bb-snapshot.sh\">Snapshot Report</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-cgi/hobbit-confreport.sh\">Config Report</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-cgi/hobbit-hostgraphs.sh\">Metrics Report</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-cgi/hobbit-ghosts.sh\">Ghost Clients</a> \
+    </div> \
+    <div class=\"outer\"> \
+      <span class=\"menutag\">Administration<span class=\"invis\">: </span></span> \
+	<a class=\"inner-1\" href=\"/hobbit-cgi/bb-findhost.sh\">Find host</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-seccgi/bb-ack.sh\">Acknowledge alert</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-seccgi/hobbit-enadis.sh\">Enable/disable</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit-seccgi/hobbit-nkedit.sh\">Edit critical systems</a> \
+    </div> \
+    <div class=\"outer\"> \
+      <span class=\"menutag\">Help<span class=\"invis\">: </span></span> \
+	<a class=\"inner-1\" href=\"/hobbit/help/about.html\">About Hobbit</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/install.html\">Installing Hobbit</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/hobbit-config.html\">Configuring Monitoring</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/hobbit-alerts.html\">Configuring Alerts</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/criticalsystems.html\">Critical systems</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/known-issues.html\">Known problems</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/hobbit-tips.html\">Tips and Tricks</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/howtograph.html\">Custom graphs</a><span class=\"invis\"> | </span> \
+	<a class=\"inner\" href=\"/hobbit/help/manpages/\">Hobbit man-pages</a> \
+    </div> \
+</div><!-- menuebox -->"
diff -r 901f2e7621ca debian/rules
--- a/debian/rules	Wed Aug 15 13:32:16 2007 +0200
+++ b/debian/rules	Sat Aug 18 20:46:51 2007 +0200
@@ -50,8 +50,7 @@ Makefile: configure
 	./configure
 
 build: build-stamp
-
-build-stamp:  Makefile
+build-stamp: Makefile
 	dh_testdir
 
 	# Add here commands to compile the package.
@@ -63,105 +62,94 @@ clean:
 	dh_testdir
 	dh_testroot
 	rm -f build-stamp 
-
-	-$(MAKE) distclean
+	[ ! -f Makefile ] || $(MAKE) distclean
 	dh_clean 
 
-install: build
+install-clean:
+	dh_clean -k
+
+install: build install-clean
 	dh_testdir
 	dh_testroot
-	dh_clean -k 
-	dh_installdirs
+	dh_installdirs -a
 	PKGBUILD=1 INSTALLROOT=$(CURDIR)/debian/hobbit/ $(MAKE) install
-	cd $(CURDIR)/debian/hobbit/usr/bin && ln -s ../lib/hobbit/server/bin/{bb,bbcmd} .
-	cd $(CURDIR)/debian/hobbit/usr/lib/hobbit/client && mv etc/hobbitclient.cfg $(CURDIR)/debian/hobbit/etc/hobbit && rm -rf $(CURDIR)/debian/hobbit/usr/lib/hobbit/client/etc && ln -s ../../../../etc/hobbit etc
-	cd $(CURDIR)/debian/hobbit/usr/lib/hobbit/client && rmdir logs && ln -s ../../../../var/log/hobbit logs
-	cd $(CURDIR)/debian/hobbit/usr/lib/hobbit/client && rmdir tmp  && ln -s ../../../../var/lib/hobbit/tmp tmp
+	cd $(CURDIR)/debian/hobbit/var/lib/hobbit/www && \
+		mv gifs ../../../../usr/share/hobbit && ln -s ../../../../usr/share/hobbit/gifs . && \
+		mv help ../../../../usr/share/hobbit && ln -s ../../../../usr/share/hobbit/help . && \
+		mv menu ../../../../usr/share/hobbit && ln -s ../../../../usr/share/hobbit/menu .
+	# We depend on the -client package
+	rm -rf $(CURDIR)/debian/hobbit/usr/lib/hobbit/client
+	# These variables are managed by debconf in /etc/default/hobbit
+	sed -i -e's!^BBSERVERHOSTNAME=.*!include /etc/default/hobbit!' \
+		-e'/^BBSERVERIP=/d' -e'/^BBSERVERWWWNAME=/d' \
+		$(CURDIR)/debian/hobbit/etc/hobbit/hobbitserver.cfg
+	# Fix some paths
+	sed -i -e's!pidfile=\$$[^/]*/!pidfile=/var/run/hobbit/!' \
+		-e's!/usr/lib/hobbit/\(server\|client\)/etc!/etc/hobbit!' \
+		$(CURDIR)/debian/hobbit/etc/hobbit/hobbitlaunch.cfg
+	mv $(CURDIR)/debian/hobbit/etc/hobbit/hobbit-apache.conf \
+		$(CURDIR)/debian/hobbit/etc/apache2/conf.d/hobbit
+	# Access restricted by default
+	sed -i -e's/Allow from all/Allow from localhost/' \
+		$(CURDIR)/debian/hobbit/etc/apache2/conf.d/hobbit
+	# We use a modified version of this as /etc/init.d/hobbit
+	rm $(CURDIR)/debian/hobbit/usr/lib/hobbit/server/hobbit.sh
+	# Autogenerated on first install
+	rm $(CURDIR)/debian/hobbit/etc/hobbit/bb-hosts
 
 
-install-client: build
+install-client: build install-clean
 	dh_testdir
 	dh_testroot
-	dh_clean -k 
-	dh_installdirs
+	dh_installdirs -a
 	PKGBUILD=1 INSTALLROOT=$(CURDIR)/debian/hobbit-client/ $(MAKE) install-client
-	cp debian/hobbit-client.default $(CURDIR)/debian/hobbit-client/etc/default/hobbit-client
 	mkdir -p $(CURDIR)/debian/hobbit-client/var/log/hobbit
 	mkdir -p $(CURDIR)/debian/hobbit-client/etc/hobbit
 	cd $(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client && mv etc/* $(CURDIR)/debian/hobbit-client/etc/hobbit && rmdir etc && ln -s ../../../../etc/hobbit etc
 	cd $(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client && rmdir logs && ln -s ../../../../var/log/hobbit logs
 	cd $(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client && rmdir tmp && ln -s ../../../../tmp tmp
-	mv $(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client/etc/hobbitclient.cfg /tmp/hobbitclient.cfg.$$
-	cat /tmp/hobbitclient.cfg.$$ | sed -e 's!^BBDISP=.*!include /var/run/hobbitclient-runtime.cfg!' | grep -v "^BBDISPLAYS=" >$(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client/etc/hobbitclient.cfg
+	cd $(CURDIR)/debian/hobbit-client/usr/bin && \
+		ln -s ../lib/hobbit/client/bin/bb ../lib/hobbit/client/bin/bbcmd .
+	# These variables are managed by debconf in /etc/default/hobbit-client
+	sed -i -e's!^BBDISP=.*!include /etc/default/hobbit-client!' \
+		-e'/^BBDISPLAYS=/d' \
+		$(CURDIR)/debian/hobbit-client/etc/hobbit/hobbitclient.cfg
+	# Fix some paths
+	sed -i -e's!\$$[^ ]*/\([^ ]*\.pid\)!/var/run/hobbit/\1!' \
+		-e's!\$$HOBBITCLIENTHOME/etc!/etc/hobbit!' \
+		-e's!\$$HOBBITCLIENTHOME/logs!/var/log/hobbit!' \
+		$(CURDIR)/debian/hobbit-client/etc/hobbit/clientlaunch.cfg \
+		$(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client/runclient.sh
 
 
-# Build architecture-independent files here.
-binary-indep: build install
-# We have nothing to do by default.
+binary-indep:
 
-hobbit: DH_OPTIONS=--package=hobbit
-hobbit: build install
-	dh_testdir
-	dh_testroot
-	dh_installchangelogs Changes
-	dh_installdocs
-	dh_installexamples
-#	dh_install
-#	dh_installmenu
-	dh_installdebconf	
-	dh_installlogrotate
-#	dh_installemacsen
-#	dh_installpam
-#	dh_installmime
-	dh_installinit
-#	dh_installcron
-#	dh_installinfo
-	dh_installman
-	dh_link
-#	dh_strip
-	dh_compress
-	dh_fixperms
-#	dh_perl
-#	dh_python
-#	dh_makeshlibs
-	dh_installdeb
-	dh_shlibdeps
-	dh_gencontrol
-	dh_md5sums
-	dh_builddeb
+binary binary-arch: build install install-client
+	dh_testdir -a
+	dh_testroot -a
+	dh_installchangelogs -a Changes
+	dh_installdocs -a
+	dh_installexamples -a
+	# move some files into the client package
+	dh_movefiles --sourcedir=debian/hobbit -a
+	cd $(CURDIR)/debian/hobbit/usr/lib/hobbit/server/bin && \
+		for f in * ; do \
+			if [ -f $(CURDIR)/debian/hobbit-client/usr/lib/hobbit/client/bin/$$f ] ; then \
+				rm -v $$f ; ln -s ../../client/bin/$$f ; \
+			fi \
+		done
+	dh_installdebconf -a
+	dh_installlogrotate -a
+	dh_installinit -a
+	dh_installman -a
+	dh_link -a
+	dh_strip -a
+	dh_compress -a
+	dh_fixperms -a
+	dh_installdeb -a
+	dh_shlibdeps -a
+	dh_gencontrol -a
+	dh_md5sums -a
+	dh_builddeb -a
 
-hobbit-client: DH_OPTIONS=--package=hobbit-client
-hobbit-client: build install-client
-	dh_testdir
-	dh_testroot
-	dh_installchangelogs Changes
-	dh_installdocs
-	dh_installexamples
-#	dh_install
-#	dh_installmenu
-	dh_installdebconf	
-	dh_installlogrotate
-#	dh_installemacsen
-#	dh_installpam
-#	dh_installmime
-	dh_installinit
-#	dh_installcron
-#	dh_installinfo
-	dh_installman
-	dh_link
-#	dh_strip
-	dh_compress
-	dh_fixperms
-#	dh_perl
-#	dh_python
-#	dh_makeshlibs
-	dh_installdeb
-	dh_shlibdeps
-	dh_gencontrol
-	dh_md5sums
-	dh_builddeb
-
-binary-arch: hobbit hobbit-client
-
-binary: binary-indep binary-arch
 .PHONY: build clean binary-indep binary-arch binary install 
diff -r 901f2e7621ca debian/watch
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/debian/watch	Sat Aug 18 20:46:51 2007 +0200
@@ -0,0 +1,2 @@
+version=3
+http://sf.net/hobbitmon/hobbit-(.*).tar.gz
